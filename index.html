<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisis E-Commerce Indonesia</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body { font-family: 'Segoe UI', Arial, sans-serif; margin: 0; background-color: #f0f2f5; color: #333; }
        
        /* 1. Page Selamat Datang */
        #welcome-page {
            height: 100vh; width: 100%; display: flex; flex-direction: column;
            justify-content: center; align-items: center; background: #2c3e50;
            color: white; text-align: center; position: fixed; z-index: 10000; transition: 0.8s;
        }
        .btn-visit {
            background-color: #27ae60; color: white; border: none; padding: 15px 40px;
            font-size: 1.2rem; border-radius: 30px; cursor: pointer; margin-top: 20px; transition: 0.3s;
        }

        /* 2. Navigasi Tab */
        #main-content { display: none; }
        nav { background: #34495e; padding: 15px; text-align: center; position: sticky; top: 0; z-index: 999; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        nav button { 
            background: rgba(255,255,255,0.1); border: 1px solid white; color: white; padding: 10px 20px; 
            margin: 5px; cursor: pointer; border-radius: 5px; font-weight: bold; transition: 0.3s;
        }
        nav button:hover, nav button.active-btn { background: white; color: #34495e; }

        .page { display: none; padding: 20px; max-width: 1200px; margin: auto; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .active { display: block; }

        /* 3. Komponen Visual */
        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 20px; }
        #map { height: 550px; width: 100%; border-radius: 8px; }
        .chart-container { height: 450px; }

        /* 4. Styling Tabel Potensial */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        table, th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #2c3e50; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }

        /* 5. Legenda Peta */
        .legend { 
            background: white; padding: 12px; line-height: 24px; color: #333; 
            border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.2); font-size: 12px;
        }
        .legend i { width: 18px; height: 18px; float: left; margin-right: 10px; opacity: 0.8; border-radius: 50%; }

        /* 6. Footer */
        footer { text-align: center; padding: 30px; background: #2c3e50; color: white; margin-top: 50px; }
    </style>
</head>
<body>

<div id="welcome-page">
    <h1>Selamat Datang di Portal Analisis</h1>
    <p>Visualisasi Geospasial & Analisis Wilayah Potensial Penjualan E-Commerce</p>
    <button class="btn-visit" onclick="bukaDashboard()">Kunjungi Dashboard</button>
</div>

<div id="main-content">
    <nav>
        <button id="btn-peta" class="active-btn" onclick="showPage('peta-page', this)">üìç Peta Sebaran</button>
        <button onclick="showPage('grafik-page', this)">üìä Grafik Statistik</button>
        <button onclick="showPage('potensial-page', this)">üöÄ Wilayah Potensial</button>
    </nav>

    <div id="peta-page" class="page active">
        <div class="card">
            <h2>Peta Interaktif Penjualan Kabupaten/Kota</h2>
            <p>Ukuran lingkaran merepresentasikan besarnya total pembayaran di wilayah tersebut.</p>
            <div id="map"></div>
        </div>
    </div>

    <div id="grafik-page" class="page">
        <div class="card">
            <h2>Perbandingan Penjualan Antar Provinsi</h2>
            <div class="chart-container">
                <canvas id="salesChart"></canvas>
            </div>
        </div>
    </div>

    <div id="potensial-page" class="page">
        <div class="card">
            <h2>üöÄ Rekomendasi Wilayah Potensial</h2>
            <p>Berdasarkan total transaksi tertinggi untuk strategi ekspansi bisnis.</p>
            
            <h3>Top 5 Provinsi Potensial</h3>
            <div id="table-provinsi"></div>

            <br>
            <h3>Top 5 Kabupaten/Kota Potensial</h3>
            <div id="table-kabkota"></div>
        </div>
    </div>

    <footer>
        <p>Dashboard Analisis Data E-Commerce Indonesia</p>
        <p>Disusun Oleh:</p>
        <p><b>Rizki Chandra | Damar Wyasa Seta | Rizal Fauzan Rosyadi</b></p>
    </footer>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    function bukaDashboard() {
        document.getElementById('welcome-page').style.transform = 'translateY(-100%)';
        setTimeout(() => {
            document.getElementById('welcome-page').style.display = 'none';
            document.getElementById('main-content').style.display = 'block';
            map.invalidateSize();
        }, 800);
    }

    function showPage(pageId, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-btn'));
        document.getElementById(pageId).classList.add('active');
        btn.classList.add('active-btn');
        if(pageId === 'peta-page') map.invalidateSize();
    }

    // MAP SETUP
    var map = L.map('map').setView([-2.5, 118], 5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function getColor(d) {
        return d > 10000000 ? '#800026' :
               d > 5000000  ? '#BD0026' :
               d > 1000000  ? '#E31A1C' :
               d > 500000   ? '#FC4E2A' : '#FD8D3C';
    }

    let statsProvinsi = {};
    let rawData = [];

    Papa.parse("ecommerce_kabkota_centroid.csv", {
        download: true,
        header: true,
        complete: function(results) {
            rawData = results.data.filter(r => r.total_pembayaran);
            
            rawData.forEach(row => {
                const val = parseFloat(row.total_pembayaran);
                const prov = row.PROVINSI;
                statsProvinsi[prov] = (statsProvinsi[prov] || 0) + val;

                L.circleMarker([row.lat, row.lon], {
                    radius: Math.sqrt(val) * 0.02 + 4,
                    fillColor: getColor(val),
                    color: "#fff", weight: 1, fillOpacity: 0.7
                }).bindPopup(`<b>${row.KAB_KOTA}</b><br>Rp ${val.toLocaleString('id-ID')}`).addTo(map);
            });
            
            createChart();
            renderPotensialTables();
        }
    });

    // LEGENDA PETA
    var legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
        var div = L.DomUtil.create('div', 'legend'),
            grades = [0, 500000, 1000000, 5000000, 10000000];
        div.innerHTML += '<b>Legenda Penjualan</b><br>';
        for (var i = 0; i < grades.length; i++) {
            div.innerHTML += '<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
                'Rp ' + grades[i].toLocaleString('id-ID') + (grades[i+1] ? '+' : '++') + '<br>';
        }
        return div;
    };
    legend.addTo(map);

    function createChart() {
        const ctx = document.getElementById('salesChart').getContext('2d');
        const labels = Object.keys(statsProvinsi).sort((a,b) => statsProvinsi[b] - statsProvinsi[a]).slice(0, 10);
        const values = labels.map(l => statsProvinsi[l]);

        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{ label: 'Total Penjualan (Rp)', data: values, backgroundColor: '#3498db' }]
            },
            options: { responsive: true, maintainAspectRatio: false }
        });
    }

    function renderPotensialTables() {
        // Table Provinsi
        const topProv = Object.entries(statsProvinsi).sort((a,b) => b[1] - a[1]).slice(0, 5);
        let htmlProv = "<table><tr><th>Peringkat</th><th>Nama Provinsi</th><th>Total Transaksi</th></tr>";
        topProv.forEach((item, i) => {
            htmlProv += `<tr><td>${i+1}</td><td>${item[0]}</td><td>Rp ${item[1].toLocaleString('id-ID')}</td></tr>`;
        });
        document.getElementById('table-provinsi').innerHTML = htmlProv + "</table>";

        // Table Kab/Kota
        const topKab = rawData.sort((a,b) => b.total_pembayaran - a.total_pembayaran).slice(0, 5);
        let htmlKab = "<table><tr><th>Peringkat</th><th>Kota/Kabupaten</th><th>Provinsi</th><th>Total Transaksi</th></tr>";
        topKab.forEach((item, i) => {
            htmlKab += `<tr><td>${i+1}</td><td>${item.KAB_KOTA}</td><td>${item.PROVINSI}</td><td>Rp ${parseFloat(item.total_pembayaran).toLocaleString('id-ID')}</td></tr>`;
        });
        document.getElementById('table-kabkota').innerHTML = htmlKab + "</table>";
    }
</script>
</body>
</html>
